#!/gsc/software/linux-x86_64-centos7/R-4.1.3/lib64/R/bin/R
# R 4.1.3
# x86_64-centos7-linux-gnu
library(plyranges)
library(VariantAnnotation)
library(MutationalPatterns)
library(genomation)
library(Gviz)
library(BSgenome.Hsapiens.UCSC.hg38)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library(systemPipeR)
library(biomaRt)
library(LDlinkR)
library(AllelicImbalance)
library(broom)
library(gt)
library(gtsummary)
library(UpSetR)
library(tidyverse)

const_canonical_chromosomes <- str_c("chr", c(1:22, "X"))

vector_marks <- c("H3K4me3", "H3K4me1", "H3K27ac", "H3K9me3", "H3K27me3", "H3K36me3")
vector_celltypes <- c("BC", "LP", "LC", "SC")
vector_individuals <- c("Individual_14_17_LP_DNA",
                        "Individual_14_18_BC__356K_RNA",
                        "Individual_11_18_BC_RNA_DNA",
                        "Individual_22_18_BC_RNA_DNA",
                        "Individual_24_18_BC_RNA_DNA",
                        "Individual_38_18_LC_RNA_DNA",
                        "Individual_30_18_LC_RNA_DNA",
                        "Individual_15_18_LC_RNA_DNA")
##############################################################################################################################################################################################
##############################################################################################################################################################################################
# Import ChIP-seq treatment bam file (test)
test_reads <- 
    impBamGAL(UserDir = "/projects/epigenomics3/epigenomics3_results/users/ahauduc/arp/project/modules/1/output2/H3K4me3/CEMT_154/epi_mark_alignment/",
              files = "CEMT_154.treatment.keep.merged.rmdup.sorted.bam",
              searchArea = 
                  consensus.all.spaas.rpkm.bed %>% 
                  plyranges::filter(mark == "H3K4me3", celltype == "BC") %>% 
                  keepSeqlevels(const_canonical_chromosomes, pruning.mode = "coarse"))

# Prioritize heterozygote positions
test_heterozygotePositions <- scanForHeterozygotes(test_reads)

# Get allele counts vector
test_countList <- getAlleleCounts(test_reads, test_heterozygotePositions)


# Below might be optional
test_ASEset <- ASEsetFromCountList(test_heterozygotePositions, test_countList)

