#!/gsc/software/linux-x86_64-centos7/R-4.1.3/lib64/R/bin/R
# R 4.1.3
# x86_64-centos7-linux-gnu
library(plyranges)
library(VariantAnnotation)
library(MutationalPatterns)
library(genomation)
library(Gviz)
library(BSgenome.Hsapiens.UCSC.hg38)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library(systemPipeR)
library(biomaRt)
library(LDlinkR)
library(AllelicImbalance)
library(broom)
library(gt)
library(gtsummary)
library(UpSetR)
library(tidyverse)

const_canonical_chromosomes <- str_c("chr", c(1:22, "X"))

vector_marks <- c("H3K4me3", "H3K4me1", "H3K27ac", "H3K9me3", "H3K27me3", "H3K36me3")
vector_celltypes <- c("BC", "LP", "LC", "SC")
vector_individuals <- c("Individual_14_17_LP_DNA",
                        "Individual_14_18_BC__356K_RNA",
                        "Individual_11_18_BC_RNA_DNA",
                        "Individual_22_18_BC_RNA_DNA",
                        "Individual_24_18_BC_RNA_DNA",
                        "Individual_38_18_LC_RNA_DNA",
                        "Individual_30_18_LC_RNA_DNA",
                        "Individual_15_18_LC_RNA_DNA")
##############################################################################################################################################################################################
##############################################################################################################################################################################################
# Create new object for H3K4me1 peaks organized by individual-celltype combo
list_treat_pileup_bw_wasp_files_H3K4me1 <- list()

# Copy over corresponding GRanges
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_1_BC <- list_treat_pileup_bw_wasp_files$H3K4me1_BC[[1]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_2_BC <- list_treat_pileup_bw_wasp_files$H3K4me1_BC[[2]] 
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_3_BC <- list_treat_pileup_bw_wasp_files$H3K4me1_BC[[3]] 
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_4_BC <- list_treat_pileup_bw_wasp_files$H3K4me1_BC[[4]] 
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_5_BC <- list_treat_pileup_bw_wasp_files$H3K4me1_BC[[5]] 
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_6_BC <- list_treat_pileup_bw_wasp_files$H3K4me1_BC[[6]] 
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_7_BC <- list_treat_pileup_bw_wasp_files$H3K4me1_BC[[7]] 
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_8_BC <- list_treat_pileup_bw_wasp_files$H3K4me1_BC[[8]] 
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_1_LP <- list_treat_pileup_bw_wasp_files$H3K4me1_LP[[1]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_2_LP <- list_treat_pileup_bw_wasp_files$H3K4me1_LP[[2]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_3_LP <- list_treat_pileup_bw_wasp_files$H3K4me1_LP[[3]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_4_LP <- list_treat_pileup_bw_wasp_files$H3K4me1_LP[[4]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_5_LP <- list_treat_pileup_bw_wasp_files$H3K4me1_LP[[5]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_6_LP <- list_treat_pileup_bw_wasp_files$H3K4me1_LP[[6]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_7_LP <- list_treat_pileup_bw_wasp_files$H3K4me1_LP[[7]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_8_LP <- list_treat_pileup_bw_wasp_files$H3K4me1_LP[[8]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_1_LC <- list_treat_pileup_bw_wasp_files$H3K4me1_LC[[1]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_2_LC <- list_treat_pileup_bw_wasp_files$H3K4me1_LC[[2]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_3_LC <- list_treat_pileup_bw_wasp_files$H3K4me1_LC[[3]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_4_LC <- list_treat_pileup_bw_wasp_files$H3K4me1_LC[[4]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_5_LC <- list_treat_pileup_bw_wasp_files$H3K4me1_LC[[5]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_6_LC <- list_treat_pileup_bw_wasp_files$H3K4me1_LC[[6]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_7_LC <- list_treat_pileup_bw_wasp_files$H3K4me1_LC[[7]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_8_LC <- list_treat_pileup_bw_wasp_files$H3K4me1_LC[[8]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_1_SC <- list_treat_pileup_bw_wasp_files$H3K4me1_SC[[1]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_2_SC <- list_treat_pileup_bw_wasp_files$H3K4me1_SC[[2]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_3_SC <- list_treat_pileup_bw_wasp_files$H3K4me1_SC[[3]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_4_SC <- list_treat_pileup_bw_wasp_files$H3K4me1_SC[[4]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_5_SC <- list_treat_pileup_bw_wasp_files$H3K4me1_SC[[5]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_6_SC <- list_treat_pileup_bw_wasp_files$H3K4me1_SC[[6]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_7_SC <- list_treat_pileup_bw_wasp_files$H3K4me1_SC[[7]]
list_treat_pileup_bw_wasp_files_H3K4me1$Individual_8_SC <- list_treat_pileup_bw_wasp_files$H3K4me1_SC[[8]]

# Create new combos for all possible individual-celltypes
# Non-redundant pair combinations
individual_celltype_combos <- combn(names(list_treat_pileup_bw_wasp_files_H3K4me1), 2) %>% t()

# Instantiate dataframes
cluster_matrix_long_individuals_celltypes_spearman_H3K4me1 <- data.frame()
cluster_matrix_short_individuals_celltypes_spearman_H3K4me1 <- list()

# Test every combination of individuals for jaccard and build distances into a labelled dataframe
for (COMBINATION_ROW in 1:nrow(individual_celltype_combos)) {
    
    current_frame <- data.frame(sample1 = individual_celltype_combos[COMBINATION_ROW, 1],
                                sample2 = individual_celltype_combos[COMBINATION_ROW, 2],
                                correlation = granges_peak_cor(list_treat_pileup_bw_wasp_files_H3K4me1[[individual_celltype_combos[COMBINATION_ROW, 1]]],
                                                               list_treat_pileup_bw_wasp_files_H3K4me1[[individual_celltype_combos[COMBINATION_ROW, 2]]],
                                                               list_peak_H3K4me1[[individual_celltype_combos[COMBINATION_ROW, 1]]],
                                                               list_peak_H3K4me1[[individual_celltype_combos[COMBINATION_ROW, 2]]],
                                                               blacklist_regions_gr = blacklist_encode,
                                                               cor_method = "spearman",
                                                               tile_widths = 50))
    
    cluster_matrix_long_individuals_celltypes_spearman_H3K4me1 <- bind_rows(cluster_matrix_long_individuals_celltypes_spearman_H3K4me1, current_frame)
    
    # Show progress
    message(str_c(current_frame[1,1], current_frame[1,2], current_frame[1,3], sep = " "))
    
}

# Add same sample matches
cluster_matrix_long_individuals_celltypes_spearman_H3K4me1 <- 
    cluster_matrix_long_individuals_celltypes_spearman_H3K4me1 %>% 
    bind_rows(data.frame(sample1 = names(list_peak_H3K4me1),
                         sample2 = names(list_peak_H3K4me1),
                         correlation = 1))

cluster_matrix_short_individuals_celltypes_spearman_H3K4me1 <- 
    cluster_matrix_long_individuals_celltypes_spearman_H3K4me1 %>% 
    pivot_wider(names_from = sample2, values_from = correlation) %>% 
    column_to_rownames("sample1") %>% 
    relocate(32, 1:31) %>% 
    as.matrix()

# Create a distance matrix from long dataframe
cluster_matrix_short_individuals_celltypes_spearman_H3K4me1 %>% 
    reshape2::melt(na.rm = TRUE) %>% 
    ggplot(aes(Var2, Var1, fill = value)) +
    geom_tile(color = "white") +
    scale_fill_gradient2(low = "blue",
                         mid = "white",
                         high = "red", 
                         limit = c(-1, 1), 
                         space = "Lab", 
                         name = "H3K4me1 Peak\nSpearman Correlations") +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, 
                                     size = 3, hjust = 1),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank(),
          axis.ticks = element_blank(),
          axis.text.y = element_text(size = 3),
          legend.justification = c(1, 0),
          legend.position = c(0.6, 0.7),
          legend.direction = "horizontal") +
    coord_fixed() + 
    geom_text(aes(Var2, Var1, label = round(value, 2)), color = "black", size = 1) +
    guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                                 title.position = "top", title.hjust = 0.5))
ggsave("plots/heatmap_spearman_individual_celltype_H3K4me1_peaks.png")
